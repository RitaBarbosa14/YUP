
import { RawSaleData, CitySummary, SegmentSummary } from './types';

// O texto bruto fornecido no prompt
const rawTextData = `LESTE - JOLIS	BAR/MERCEARIA/LANCHONETE	JATAIZINHO	58,8	68	06/11/2025	58,8
LESTE - JOLIS	MERCADO	JATAIZINHO	117,6	68	06/11/2025	117,6
LESTE - JOLIS	RESTAURANTE	JATAIZINHO	74,43	152	14/08/2025	85,9
OESTE  - JOLIS	BAR/MERCEARIA/LANCHONETE	CAMBE	26	278	10/04/2025	26
OESTE  - JOLIS	CONVENIENCIA	CAMBE	117,6	21	23/12/2025	117,6
OESTE  - JOLIS	CONVENIENCIA	CAMBE	117,6	74	31/10/2025	117,6
OESTE  - JOLIS	POSTO DE GASOLINA	CAMBE	176,4	67	07/11/2025	176,4
SUL  - JOLIS	BAR/MERCEARIA/LANCHONETE	LONDRINA	156,72	55	19/11/2025	253,1
SUL  - JOLIS	MERCADO	LONDRINA	39,9	166	31/07/2025	39,9
SUL  - JOLIS	MERCADO	LONDRINA	117,6	69	05/11/2025	117,6
SUL  - JOLIS	PANIF E CONF	TAMARANA	379,7	354	24/01/2025	379,7
SUL  - JOLIS	PANIF E CONF	LONDRINA	135,66	145	21/08/2025	139,65
SUL  - JOLIS	SUPERMERCADO	LONDRINA	217,44	55	19/11/2025	176,4
SUL  - JOLIS	SUPERMERCADO	TAMARANA	491,23	60	14/11/2025	212,8
SUL  - JOLIS	FARMACIA	LONDRINA	117,6	55	19/11/2025	117,6
NORTE - JOLIS	BAR/MERCEARIA/LANCHONETE	LONDRINA	28,68	146	20/08/2025	28,68
NORTE - JOLIS	BAR/MERCEARIA/LANCHONETE	LONDRINA	29,55	82	23/10/2025	29,55
NORTE - JOLIS	PANIF E CONF	LONDRINA	125,8	329	18/02/2025	125,8
NORTE - JOLIS	CANTINA ESCOLAS	LONDRINA	117,6	49	25/11/2025	117,6
CENTRO - JOLIS	BAR/MERCEARIA/LANCHONETE	LONDRINA	119,94	113	22/09/2025	55,45
CENTRO - JOLIS	BAR/MERCEARIA/LANCHONETE	LONDRINA	267,94	1	12/01/2026	300
CENTRO - JOLIS	BAR/MERCEARIA/LANCHONETE	LONDRINA	164,64	5	08/01/2026	117,6
CENTRO - JOLIS	SUPERMERCADO	LONDRINA	117,6	68	06/11/2025	117,6
CENTRO - JOLIS	POSTO DE GASOLINA	LONDRINA	252,94	134	01/09/2025	223,44
LESTE - KHALIL	BAR/MERCEARIA/LANCHONETE	PINHAIS	160,35	95	10/10/2025	160,35
LESTE - KHALIL	BAR/MERCEARIA/LANCHONETE	PIRAQUARA	108	158	08/08/2025	108
LESTE - KHALIL	SACOLAO	COLOMBO	176,4	27	17/12/2025	176,4
LESTE - KHALIL	SACOLAO	PINHAIS	270,66	40	04/12/2025	236,8
LESTE - KHALIL	CONVENIENCIA	PINHAIS	176,4	95	10/10/2025	176,4
LESTE - KHALIL	PESQUE E PAGUE	PIRAQUARA	355,47	18	26/12/2025	660,2
CENTRO - FABIO B. 	LANCHONETES	CURITIBA	272,1	305	14/03/2025	252
CENTRO - FABIO B. 	LANCHONETES	CURITIBA	173,87	49	25/11/2025	144
CENTRO - FABIO B. 	COMERCIO	CURITIBA	217,9	137	29/08/2025	159,8
CENTRO - FABIO B. 	COMERCIO	CURITIBA	180,65	116	19/09/2025	124
CENTRO - FABIO B. 	CONVENIENCIA	CURITIBA	177,8	27	17/12/2025	149,7
CENTRO - FABIO B. 	CONVENIENCIA	CURITIBA	117,6	85	20/10/2025	117,6
CENTRO - FABIO B. 	RESTAURANTE	CURITIBA	295,41	5	08/01/2026	323,6
CENTRO - FABIO B. 	RESTAURANTE	CURITIBA	107,2	197	30/06/2025	107,2
CENTRO - FABIO B. 	PANIF E CONF	CURITIBA	237,08	144	22/08/2025	209,1
NORTE - ORAIDES	COMERCIO	CURITIBA	216,96	186	11/07/2025	216,96
NORTE - ORAIDES	CONVENIENCIA	ALMIRANTE TAMANDARE	176,4	55	19/11/2025	235,2
NORTE - ORAIDES	CONVENIENCIA	CAMPINA GRANDE DO SUL	200,6	49	25/11/2025	294
LESTE - ORAIDES	COMERCIO	PINHAIS	176,4	32	12/12/2025	117,6
LESTE - ORAIDES	COMERCIO	PINHAIS	374,84	5	08/01/2026	149,7
LESTE - ORAIDES	COMERCIO	PINHAIS	466,56	90	15/10/2025	294
LESTE - ORAIDES	CONVENIENCIA	PINHAIS	637,9	74	31/10/2025	637,9
LESTE - ORAIDES	CONVENIENCIA	PINHAIS	523,11	190	07/07/2025	718,92
LESTE - ORAIDES	SORVETERIA - COMERCIO	PIRAQUARA	319,56	197	30/06/2025	319,56
LESTE - ORAIDES	MERCADO	PINHAIS	824	197	30/06/2025	838,8
DANIEL ALVES 	BAR/MERCEARIA/LANCHONETE	CURITIBA	235,2	85	20/10/2025	235,2
DANIEL ALVES 	CONVENIENCIA	CURITIBA	176,4	85	20/10/2025	176,4
DANIEL ALVES 	MERCADO	CURITIBA	131,84	109	26/09/2025	131,84
DANIEL ALVES 	PANIF E CONF	PIRAQUARA	575,8	61	13/11/2025	1392,5
NORTE KHALIL	CONVENIENCIA	ITAPERUCU	176,4	41	03/12/2025	176,4
SUL - FABIO B.	LANCHONETES	CURITIBA	126,75	5	08/01/2026	130
SUL - FABIO B.	CONVENIENCIA	CURITIBA	144	158	08/08/2025	144
SUL - FABIO B.	SORVETERIA - COMERCIO	CURITIBA	460,56	137	29/08/2025	1040
SUL - FABIO B.	MERCADO	CURITIBA	362,9	144	22/08/2025	375
SUL - FABIO B.	PANIF E CONF	CURITIBA	304,1	204	23/06/2025	304,1
SUL - FABIO B.	SUPERMERCADO	CURITIBA	150	158	08/08/2025	150
SUL - FABIO B.	CANTINA ESCOLAS	SAO JOSE DOS PINHAIS	199,5	204	23/06/2025	199,5
SUL - ORAIDES	CONVENIENCIA	CURITIBA	102,4	236	22/05/2025	102,4
SUL - ORAIDES	CONVENIENCIA	CURITIBA	117,6	81	24/10/2025	117,6
SUL - ORAIDES	CONVENIENCIA	CURITIBA	594,51	74	31/10/2025	352,8
SUL - ORAIDES	PESQUE E PAGUE	CURITIBA	239,4	179	18/07/2025	239,4
CENTRO KHALIL	BAR/MERCEARIA/LANCHONETE	CURITIBA	383,53	35	09/12/2025	427,9
CENTRO KHALIL	MERCADO	CURITIBA	102	197	30/06/2025	52
CENTRO KHALIL	CASA DE CARNE/ACOUGUE	CURITIBA	177,6	68	06/11/2025	177,6
PONTA GROSSA - KHALIL	MERCADO	PONTA GROSSA	117,6	5	08/01/2026	117,6
PONTA GROSSA - KHALIL	CLUBE ESPORTIVO	PONTA GROSSA	268,4	280	08/04/2025	286,9
CENTRO - ORAIDES	BAR/MERCEARIA/LANCHONETE	CURITIBA	252,04	305	14/03/2025	144
CENTRO - ORAIDES	COMERCIO	CURITIBA	294	22	22/12/2025	294
LESTE FABIO B. 	SUPERMERCADO	CURITIBA	551,22	27	17/12/2025	372,4
NORTE - FABIO B. 	CONVENIENCIA	CURITIBA	220,45	116	19/09/2025	126
NORTE - FABIO B. 	RESTAURANTE	CURITIBA	117,6	85	20/10/2025	117,6
NORTE - FABIO B. 	PANIF E CONF	CURITIBA	119,7	197	30/06/2025	119,7
OESTE - ORAIDES	SACOLAO	CURITIBA	639,12	186	11/07/2025	639,12
PADRAO YUP	LANCHONETES	LONDRINA	370,6	1	12/01/2026	414,6
PADRAO YUP	COMERCIO	LONDRINA	156,55	330	17/02/2025	156,55
PADRAO YUP	COMERCIO	ROLANDIA	175,59	56	18/11/2025	176,6
PADRAO YUP	COMERCIO	SERTANOPOLIS	721,4	174	23/07/2025	721,4
PADRAO YUP	COMERCIO	ALVORADA DO SUL	254,71	6	07/01/2026	176,6
PADRAO YUP	COMERCIO	JAGUAPITA	705,83	6	07/01/2026	441,75
PADRAO YUP	COMERCIO	BELA VISTA DO PARAISO	296,39	15	29/12/2025	265,05
PADRAO YUP	COMERCIO	TAMARANA	1059,31	6	07/01/2026	1324,5
PADRAO YUP	COMERCIO	CAMBE	803,78	6	07/01/2026	1138,65
PADRAO YUP	COMERCIO	LONDRINA	1424,71	1	12/01/2026	1398,55
PADRAO YUP	COMERCIO	ATIBAIA	4524,36	89	16/10/2025	4417,5`;

// Map segments to a consistent profitability to simulate the user request
const segmentProfitability: Record<string, number> = {
  'BAR/MERCEARIA/LANCHONETE': 0.28,
  'MERCADO': 0.18,
  'RESTAURANTE': 0.35,
  'CONVENIENCIA': 0.40,
  'POSTO DE GASOLINA': 0.22,
  'PANIF E CONF': 0.32,
  'SUPERMERCADO': 0.15,
  'FARMACIA': 0.20,
  'CANTINA ESCOLAS': 0.30,
  'SACOLAO': 0.25,
  'PESQUE E PAGUE': 0.38,
  'LANCHONETES': 0.30,
  'COMERCIO': 0.20,
  'SORVETERIA - COMERCIO': 0.45,
  'CASA DE CARNE/ACOUGUE': 0.18,
  'CLUBE ESPORTIVO': 0.35,
  'REDES SUPERMERCADO': 0.12,
  'HOTEIS': 0.40,
  'BUFFET': 0.35,
  'CLUBES SOCIAIS': 0.30,
};

export function parseData(): RawSaleData[] {
  const lines = rawTextData.trim().split('\n');
  return lines.map(line => {
    const parts = line.split('\t');
    const mediaPed = parseFloat(parts[3].replace(',', '.'));
    const vlrUlt = parseFloat(parts[parts.length - 1].replace(',', '.'));
    const seg = parts[1].trim();
    
    return {
      regiao: parts[0].trim(),
      segmento: seg,
      cidade: parts[2].trim(),
      mediaPedido: isNaN(mediaPed) ? vlrUlt : mediaPed,
      dsc: parseInt(parts[4]) || 0,
      dataUltima: parts[5] || '',
      vlrUltima: vlrUlt || 0,
      profitMargin: segmentProfitability[seg] || 0.25
    };
  });
}

export function aggregateByCity(data: RawSaleData[]): CitySummary[] {
  const cityGroups: Record<string, RawSaleData[]> = {};
  data.forEach(d => {
    if (!cityGroups[d.cidade]) cityGroups[d.cidade] = [];
    cityGroups[d.cidade].push(d);
  });

  return Object.entries(cityGroups).map(([cidade, items]) => {
    const totalVendas = items.reduce((acc, curr) => acc + curr.vlrUltima, 0);
    const sumTicket = items.reduce((acc, curr) => acc + curr.mediaPedido, 0);
    const sumProfit = items.reduce((acc, curr) => acc + (curr.vlrUltima * curr.profitMargin), 0);

    return {
      cidade,
      totalClientes: items.length,
      ticketMedio: sumTicket / items.length,
      totalVendas,
      lucratividadeMedia: (sumProfit / totalVendas) * 100
    };
  }).sort((a, b) => b.totalVendas - a.totalVendas);
}

export function aggregateBySegment(data: RawSaleData[]): SegmentSummary[] {
  const segGroups: Record<string, { count: number, total: number }> = {};
  data.forEach(d => {
    if (!segGroups[d.segmento]) segGroups[d.segmento] = { count: 0, total: 0 };
    segGroups[d.segmento].count += 1;
    segGroups[d.segmento].total += d.vlrUltima;
  });

  return Object.entries(segGroups).map(([segmento, stats]) => ({
    segmento,
    count: stats.count,
    totalVendas: stats.total
  })).sort((a, b) => b.totalVendas - a.totalVendas);
}
